--CPL_1.1
--Kod för att ta fram antal vetenskapliga publikationer per institution från CPL.
--Koden innefattar ej institutionen MV.

SELECT c.pubyear, din.inst_sv AS inst,
	CASE
		WHEN c.pubtype = 5 THEN 'Artikel'
		WHEN c.pubtype = 2 THEN 'Konferensbidrag'
		WHEN c.pubtype = 10 THEN 'Kapitel'
		ELSE 'Böcker'
	END AS pubtype,
COUNT(DISTINCT c.pubid)
FROM uplmain AS c
INNER JOIN person_publ AS pp ON c.dbid = pp.dbid
INNER JOIN dept_pers_publ AS dpp ON pp.pd_id = dpp.pd_id
INNER JOIN dept_instance AS di ON dpp.deptid = di.deptid
INNER JOIN dept_inst AS din ON dpp.deptid = din.deptid --dept_inst är en vy som anger institution för varje post i tabellen departments
WHERE di.instanceid = 1
AND din.inst_en::text ~~ 'Dep%'::text --Bara data för inst - ej centrumbildningar osv.
AND c.pubyear = 2015 --Ändra till aktuellt år
AND pubtype IN (2, 5, 9, 10)
GROUP BY c.pubyear, din.instid, din.inst_sv, c.pubtype

UNION

--Nedanstående kod lägger till data för hela DoIT resp hela ITIT
SELECT c.pubyear,
	CASE
		WHEN din.inst_sv LIKE '%data%' THEN 'Institutionen för data- och informationsteknik (Chalmers+GU)'
		WHEN din.inst_sv LIKE '%tillämpad info%' THEN 'Institutionen för tillämpad informationsteknologi (Chalmers+GU)'
	END AS inst,
	CASE
		WHEN c.pubtype = 5 THEN 'Artikel'
		WHEN c.pubtype = 2 THEN 'Konferensbidrag'
		WHEN c.pubtype = 10 THEN 'Kapitel'
		ELSE 'Böcker'
	END AS pubtype,
COUNT (DISTINCT c.pubid)
FROM uplmain AS c
INNER JOIN person_publ AS pp ON c.dbid = pp.dbid
INNER JOIN dept_pers_publ AS dpp ON pp.pd_id = dpp.pd_id
INNER JOIN dept_instance AS di ON dpp.deptid = di.deptid
INNER JOIN dept_inst AS din ON dpp.deptid = din.deptid
WHERE din.instid IN (366,1294,1293,1643)
AND c.pubyear = 2015 --Ändra till aktuellt år
AND c.pubtype IN (2, 5, 9, 10)
GROUP BY c.pubyear, c.pubtype, inst
ORDER BY pubyear, pubtype, inst


--CPL_1.2
--Kod för att ta fram antal vetenskapliga publikationer för institutionen MV från CPL.
SELECT c.pubyear,
	CASE
		WHEN c.pubtype = 5 THEN 'Artikel'
		WHEN c.pubtype = 2 THEN 'Konferensbidrag'
		WHEN c.pubtype = 10 THEN 'Kapitel'
		ELSE 'Böcker'
	END AS pubtype,
COUNT(DISTINCT c.pubid)
FROM uplmain AS c
INNER JOIN person_publ AS pp ON c.dbid = pp.dbid
INNER JOIN dept_pers_publ AS dpp ON pp.pd_id = dpp.pd_id
INNER JOIN departments AS d ON dpp.deptid = d.deptid
INNER JOIN mv_ch_gu AS mcg ON pp.personid = mcg.personid
WHERE (d.deptid = 371 OR d.parentid = 371 OR d.grandparentid = 371) --371 = MV
AND c.pubtype IN (2, 5, 9, 10)
AND c.pubyear = 2015 --Ändra till aktuellt år
AND (ch13 = 'x' OR ch14 = 'x' OR ch15 = 'x') --Uppdatera till aktuellt år -2
GROUP BY c.pubtype, c.pubyear


--CPL_1.3
--Ta fram språk för publikationer skrivna på institutionen Arkitektur (A)
SELECT
	CASE
		WHEN lang.languageid = 1 THEN 'Svenska'
		WHEN lang.languageid = 2 THEN 'Engelska'
		ELSE 'Annat'
	END AS language,
COUNT(DISTINCT c.pubid)
FROM uplmain AS c
INNER JOIN person_publ AS pp ON c.dbid = pp.dbid
INNER JOIN dept_pers_publ AS dpp ON pp.pd_id = dpp.pd_id
INNER JOIN departments AS d ON dpp.deptid = d.deptid
INNER JOIN publ_lang AS pl ON c.dbid = pl.dbid
INNER JOIN language AS lang ON pl.langid = lang.languageid
WHERE c.pubtype IN (1, 2, 4, 5, 6, 7, 9, 10, 11, 12, 16)
AND c.pubyear = 2015 --Ändra till aktuellt år
AND (d.deptid = 367 OR d.parentid = 367 OR d.grandparentid = 367) --367 = A
GROUP BY lang.languageid
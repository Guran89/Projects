--CF_2.1
--Kod som tar fram cf (exklusive självciteringar) för MV
SELECT COUNT(temp.cxfp) AS n, SUM(temp.cxfp)/COUNT(temp.cxfp) AS cxf
FROM (
SELECT DISTINCT cwts.isi_id,
	CASE
		WHEN cwts.py = 2010 THEN cwts.cx5/cwts.fcsx5 --Ändra till aktuella år
		WHEN cwts.py = 2011 THEN cwts.cx5/cwts.fcsx5
		WHEN cwts.py = 2012 THEN cwts.cx4/cwts.fcsx4
		WHEN cwts.py = 2013 THEN cwts.cx3/cwts.fcsx3
	END AS cxfp
FROM uplmain AS c
INNER JOIN cross_isi_cpl AS cic ON c.pubid = cic.cpl_pubid
INNER JOIN cwts ON cic.isi_id = cwts.isi_id
INNER JOIN person_publ AS pp ON c.dbid = pp.dbid
INNER JOIN dept_pers_publ AS dpp ON pp.pd_id = dpp.pd_id
INNER JOIN departments AS d ON dpp.deptid = d.deptid
INNER JOIN dept_inst AS din ON dpp.deptid = din.deptid
WHERE (d.deptid = 371 OR d.parentid = 371 OR d.grandparentid = 371)
AND cwts.py BETWEEN 2010 AND 2013 --Ändra till aktuella år

UNION

SELECT DISTINCT cwts.isi_id,
	CASE
		WHEN cwts.py = 2010 THEN cwts.cx5/cwts.fcsx5 --Ändra till aktuella år
		WHEN cwts.py = 2011 THEN cwts.cx5/cwts.fcsx5
		WHEN cwts.py = 2012 THEN cwts.cx4/cwts.fcsx4
		WHEN cwts.py = 2013 THEN cwts.cx3/cwts.fcsx3
	END AS cxfp
FROM uplmain AS c
INNER JOIN cross_isi_gu AS cig ON c.pubid = cig.cpl_pubid
INNER JOIN cwts ON cig.isi_id = cwts.isi_id
INNER JOIN person_publ AS pp ON c.dbid = pp.dbid
INNER JOIN dept_pers_publ AS dpp ON pp.pd_id = dpp.pd_id
INNER JOIN departments AS d ON dpp.deptid = d.deptid
INNER JOIN dept_inst AS din ON dpp.deptid = din.deptid
WHERE (d.deptid = 371 OR d.parentid = 371 OR d.grandparentid = 371)
AND cwts.py BETWEEN 2010 AND 2013 --Ändra till aktuella år
) AS temp


--CF_2.2
--Kod som tar fram cf (exklusive självciteringar) för enskilda publikationer för institutionen MV
SELECT DISTINCT cwts.isi_id,
	CASE
		WHEN cwts.py = 2010 THEN cwts.cx5/cwts.fcsx5 --Ändra till aktuella år
		WHEN cwts.py = 2011 THEN cwts.cx5/cwts.fcsx5
		WHEN cwts.py = 2012 THEN cwts.cx4/cwts.fcsx4
		WHEN cwts.py = 2013 THEN cwts.cx3/cwts.fcsx3
	END AS cxfp
FROM uplmain AS c
INNER JOIN cross_isi_cpl AS cic ON c.pubid = cic.cpl_pubid
INNER JOIN cwts ON cic.isi_id = cwts.isi_id
INNER JOIN person_publ AS pp ON c.dbid = pp.dbid
INNER JOIN dept_pers_publ AS dpp ON pp.pd_id = dpp.pd_id
INNER JOIN departments AS d ON dpp.deptid = d.deptid
INNER JOIN dept_inst AS din ON dpp.deptid = din.deptid
WHERE (d.deptid = 371 OR d.parentid = 371 OR d.grandparentid = 371)
AND cwts.py BETWEEN 2010 AND 2013 --Ändra till aktuella år

UNION

SELECT DISTINCT cwts.isi_id,
	CASE
		WHEN cwts.py = 2010 THEN cwts.cx5/cwts.fcsx5 --Ändra till aktuella år
		WHEN cwts.py = 2011 THEN cwts.cx5/cwts.fcsx5
		WHEN cwts.py = 2012 THEN cwts.cx4/cwts.fcsx4
		WHEN cwts.py = 2013 THEN cwts.cx3/cwts.fcsx3
	END AS cxfp
FROM uplmain AS c
INNER JOIN cross_isi_gu AS cig ON c.pubid = cig.cpl_pubid
INNER JOIN cwts ON cig.isi_id = cwts.isi_id
INNER JOIN person_publ AS pp ON c.dbid = pp.dbid
INNER JOIN dept_pers_publ AS dpp ON pp.pd_id = dpp.pd_id
INNER JOIN departments AS d ON dpp.deptid = d.deptid
INNER JOIN dept_inst AS din ON dpp.deptid = din.deptid
WHERE (d.deptid = 371 OR d.parentid = 371 OR d.grandparentid = 371)
AND cwts.py BETWEEN 2010 AND 2013 --Ändra till aktuella år


--CF_2.3
--Cf för MV baserad på Chalmers-/GU-adress samt anställd Chalmers
SELECT COUNT(temp.cxfp) AS n, SUM(temp.cxfp)/COUNT(temp.cxfp) AS cxf
FROM (
SELECT DISTINCT cwts.isi_id,
	CASE
		WHEN cwts.py = 2010 THEN cwts.cx5/cwts.fcsx5 --Ändra till aktuella år
		WHEN cwts.py = 2011 THEN cwts.cx5/cwts.fcsx5
		WHEN cwts.py = 2012 THEN cwts.cx4/cwts.fcsx4
		WHEN cwts.py = 2013 THEN cwts.cx3/cwts.fcsx3
	END AS cxfp
FROM uplmain AS c
INNER JOIN cross_isi_cpl AS cic ON c.pubid = cic.cpl_pubid
INNER JOIN cwts ON cic.isi_id = cwts.isi_id
INNER JOIN person_publ AS pp ON c.dbid = pp.dbid
INNER JOIN persons AS p ON pp.personid = p.personid
INNER JOIN dept_pers_publ AS dpp ON pp.pd_id = dpp.pd_id
INNER JOIN departments AS d ON dpp.deptid = d.deptid
INNER JOIN dept_inst AS din ON dpp.deptid = din.deptid
INNER JOIN mv_ch_gu AS mcg ON p.personid = mcg.personid
WHERE (d.deptid = 371 OR d.parentid = 371 OR d.grandparentid = 371)
AND (mcg.ch09 = 'x' OR mcg.ch10 = 'x' OR mcg.ch11 = 'x' OR mcg.ch12 = 'x' OR mcg.ch13 = 'x')
AND cwts.py BETWEEN 2010 AND 2013--Ändra till aktuella år

UNION

SELECT DISTINCT cwts.isi_id,
	CASE
		WHEN cwts.py = 2010 THEN cwts.cx5/cwts.fcsx5 --Ändra till aktuella år
		WHEN cwts.py = 2011 THEN cwts.cx5/cwts.fcsx5
		WHEN cwts.py = 2012 THEN cwts.cx4/cwts.fcsx4
		WHEN cwts.py = 2013 THEN cwts.cx3/cwts.fcsx3
	END AS cxfp
FROM uplmain AS c
INNER JOIN cross_isi_gu AS cig ON c.pubid = cig.cpl_pubid
INNER JOIN cwts ON cig.isi_id = cwts.isi_id
INNER JOIN person_publ AS pp ON c.dbid = pp.dbid
INNER JOIN persons AS p ON pp.personid = p.personid
INNER JOIN dept_pers_publ AS dpp ON pp.pd_id = dpp.pd_id
INNER JOIN departments AS d ON dpp.deptid = d.deptid
INNER JOIN dept_inst AS din ON dpp.deptid = din.deptid
INNER JOIN mv_ch_gu AS mcg ON p.personid = mcg.personid
WHERE (d.deptid = 371 OR d.parentid = 371 OR d.grandparentid = 371)
AND (mcg.ch09 = 'x' OR mcg.ch10 = 'x' OR mcg.ch11 = 'x' OR mcg.ch12 = 'x' OR mcg.ch13 = 'x')
AND cwts.py BETWEEN 2010 AND 2013 --Ändra till aktuella år
) AS temp


--CF_2.4
--Cf för MV baserad på Chalmers-/GU-adress samt anställd Chalmers ---- för stab intervall
SELECT DISTINCT cwts.isi_id, 
	CASE
		WHEN cwts.py = 2010 THEN cwts.cx5/cwts.fcsx5 --Ändra till aktuella år
		WHEN cwts.py = 2011 THEN cwts.cx5/cwts.fcsx5
		WHEN cwts.py = 2012 THEN cwts.cx4/cwts.fcsx4
		WHEN cwts.py = 2013 THEN cwts.cx3/cwts.fcsx3
	END AS cxfp
FROM uplmain AS c
INNER JOIN cross_isi_cpl AS cic ON c.pubid = cic.cpl_pubid
INNER JOIN cwts ON cic.isi_id = cwts.isi_id
INNER JOIN person_publ AS pp ON c.dbid = pp.dbid
INNER JOIN persons AS p ON pp.personid = p.personid
INNER JOIN dept_pers_publ AS dpp ON pp.pd_id = dpp.pd_id
INNER JOIN departments AS d ON dpp.deptid = d.deptid
INNER JOIN dept_inst AS din ON dpp.deptid = din.deptid
INNER JOIN mv_ch_gu AS mcg ON p.personid = mcg.personid
WHERE (d.deptid = 371 OR d.parentid = 371 OR d.grandparentid = 371)
AND (mcg.ch09 = 'x' OR mcg.ch10 = 'x' OR mcg.ch11 = 'x' OR mcg.ch12 = 'x' OR mcg.ch13 = 'x')
AND cwts.py BETWEEN 2010 AND 2013--Ändra till aktuella år

UNION

SELECT DISTINCT cwts.isi_id,
	CASE
		WHEN cwts.py = 2010 THEN cwts.cx5/cwts.fcsx5 --Ändra till aktuella år
		WHEN cwts.py = 2011 THEN cwts.cx5/cwts.fcsx5
		WHEN cwts.py = 2012 THEN cwts.cx4/cwts.fcsx4
		WHEN cwts.py = 2013 THEN cwts.cx3/cwts.fcsx3
	END AS cxfp
FROM uplmain AS c
INNER JOIN cross_isi_gu AS cig ON c.pubid = cig.cpl_pubid
INNER JOIN cwts ON cig.isi_id = cwts.isi_id
INNER JOIN person_publ AS pp ON c.dbid = pp.dbid
INNER JOIN persons AS p ON pp.personid = p.personid
INNER JOIN dept_pers_publ AS dpp ON pp.pd_id = dpp.pd_id
INNER JOIN departments AS d ON dpp.deptid = d.deptid
INNER JOIN dept_inst AS din ON dpp.deptid = din.deptid
INNER JOIN mv_ch_gu AS mcg ON p.personid = mcg.personid
WHERE (d.deptid = 371 OR d.parentid = 371 OR d.grandparentid = 371)
AND (mcg.ch09 = 'x' OR mcg.ch10 = 'x' OR mcg.ch11 = 'x' OR mcg.ch12 = 'x' OR mcg.ch13 = 'x')
AND cwts.py BETWEEN 2010 AND 2013 --Ändra till aktuella år


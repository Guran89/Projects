--OA.1
SELECT tempcpl.pubyear,
	CASE
		WHEN tempcpl.pubtype = 2 THEN 'Konferensbidrag'
		WHEN tempcpl.pubtype = 5 THEN 'Artikel'
	END AS pubtyp,
ROUND(tempoa.oa::NUMERIC/tempcpl.cpl::NUMERIC*100) AS kvot
FROM (
	SELECT c.pubyear, c.pubtype, COUNT(DISTINCT c.pubid) AS cpl
	FROM uplmain AS c
	INNER JOIN person_publ AS pp ON c.dbid = pp.dbid
	INNER JOIN dept_pers_publ AS dpp ON pp.pd_id = dpp.pd_id
	INNER JOIN departments AS d ON dpp.deptid = d.deptid
	WHERE c.pubtype IN (2, 5)
	AND c.pubyear BETWEEN 2011 AND 2015 --Ändra till aktuella år
	AND (d.deptid = 368 OR d.parentid = 368 OR d.grandparentid = 368)
	GROUP BY c.pubyear, c.pubtype) AS tempcpl

LEFT OUTER JOIN 

(SELECT c.pubyear, c.pubtype, COUNT(DISTINCT c.pubid) AS oa
FROM uplmain AS c
INNER JOIN person_publ AS pp ON c.dbid = pp.dbid
INNER JOIN dept_pers_publ AS dpp ON pp.pd_id = dpp.pd_id
INNER JOIN departments AS d ON dpp.deptid = d.deptid
INNER JOIN publ_links AS pl ON c.dbid = pl.dbid
WHERE c.pubtype IN (2, 5)
AND c.pubyear BETWEEN 2011 AND 2015 --Ändra till aktuella år
AND (d.deptid = 368 OR d.parentid = 368 OR d.grandparentid = 368)
AND pl.attrib = 3
GROUP BY c.pubyear, c.pubtype) AS tempoa
ON tempcpl.pubyear = tempoa.pubyear
AND tempcpl.pubtype = tempoa.pubtype
ORDER BY tempcpl.pubtype DESC, tempcpl.pubyear



SELECT tempcpl.pubyear,
	CASE
		WHEN tempcpl.pubtype = 2 THEN 'Konferensbidrag'
		WHEN tempcpl.pubtype = 5 THEN 'Artikel'
	END AS pubtyp,
ROUND(tempoa.oa::NUMERIC/tempcpl.cpl::NUMERIC*100) AS kvot
FROM (
	SELECT c.pubyear, c.pubtype, COUNT(DISTINCT c.pubid) AS cpl
	FROM uplmain AS c
	INNER JOIN person_publ AS pp ON c.dbid = pp.dbid
	INNER JOIN dept_pers_publ AS dpp ON pp.pd_id = dpp.pd_id
	INNER JOIN departments AS d ON dpp.deptid = d.deptid
	INNER JOIN mv_ch_gu AS mcg ON pp.personid = mcg.personid
	WHERE c.pubtype IN (2, 5)
	AND c.pubyear BETWEEN 2011 AND 2015 --Ändra till aktuella år
	AND (d.deptid = 371 OR d.parentid = 371 OR d.grandparentid = 371)
	AND (mcg.ch11 = 'x' OR mcg.ch12 = 'x' OR mcg.ch13 = 'x' OR mcg.ch14 = 'x' OR mcg.ch15 = 'x')
	GROUP BY c.pubyear, c.pubtype) AS tempcpl

LEFT OUTER JOIN 

(SELECT c.pubyear, c.pubtype, COUNT(DISTINCT c.pubid) AS oa
FROM uplmain AS c
INNER JOIN person_publ AS pp ON c.dbid = pp.dbid
INNER JOIN dept_pers_publ AS dpp ON pp.pd_id = dpp.pd_id
INNER JOIN departments AS d ON dpp.deptid = d.deptid
INNER JOIN publ_links AS pl ON c.dbid = pl.dbid
INNER JOIN mv_ch_gu AS mcg ON pp.personid = mcg.personid
WHERE c.pubtype IN (2, 5)
AND c.pubyear BETWEEN 2011 AND 2015 --Ändra till aktuella år
AND (d.deptid = 371 OR d.parentid = 371 OR d.grandparentid = 371)
AND (mcg.ch11 = 'x' OR mcg.ch12 = 'x' OR mcg.ch13 = 'x' OR mcg.ch14 = 'x' OR mcg.ch15 = 'x')
AND pl.attrib = 3
GROUP BY c.pubyear, c.pubtype) AS tempoa
ON tempcpl.pubyear = tempoa.pubyear
AND tempcpl.pubtype = tempoa.pubtype
ORDER BY tempcpl.pubtype DESC, tempcpl.pubyear

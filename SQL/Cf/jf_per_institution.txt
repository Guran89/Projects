--Kod för att ta fram Jf för samtliga institutioner förutom MV
SELECT temp.instid AS id, temp.sv_name AS inst, COUNT(temp.jxf) AS n, SUM(temp.jxf)/COUNT(temp.jxf) AS Jxf
FROM (
	SELECT DISTINCT cin.instid, cin.sv_name, cwts.isi_id,
		CASE
			WHEN cwts.py = 2011 THEN cwts.jcsx5/cwts.fcsx5 --Ändra till aktuella år
			WHEN cwts.py = 2012 THEN cwts.jcsx4/cwts.fcsx4
			WHEN cwts.py = 2013 THEN cwts.jcsx3/cwts.fcsx3
			WHEN cwts.py = 2014 THEN cwts.jcsx2/cwts.fcsx2
		END AS jxf
	FROM cwts
	INNER JOIN cross_isi_cpl AS cic ON cwts.isi_id = cic.isi_id
	INNER JOIN uplmain AS c ON cic.pubid = c.pubid
	INNER JOIN person_publ AS pp ON c.dbid = pp.dbid
	INNER JOIN dept_pers_publ AS dpp ON pp.pd_id = dpp.pd_id
	INNER JOIN dept_inst AS din ON dpp.deptid = din.deptid
	INNER JOIN chalmers_inst AS cin ON din.instid = cin.instid
	WHERE cwts.py BETWEEN 2011 AND 2014 --Ändra till aktuella år
	--Ta inte med MV i resultatet
	AND cin.instid != 371) AS temp
GROUP BY temp.instid, temp.sv_name
ORDER BY temp.sv_name



--Kod som tar fram jf (exklusive självciteringar) för MV
SELECT COUNT(temp.jxf) AS n, SUM(temp.jxf)/COUNT(temp.jxf) AS Jxf
FROM (
SELECT DISTINCT cwts.isi_id,
	CASE
		WHEN cwts.py = 2011 THEN cwts.jcsx5/cwts.fcsx5 --Ändra till aktuella år
		WHEN cwts.py = 2012 THEN cwts.jcsx4/cwts.fcsx4
		WHEN cwts.py = 2013 THEN cwts.jcsx3/cwts.fcsx3
		WHEN cwts.py = 2014 THEN cwts.jcsx2/cwts.fcsx2
	END AS jxf
FROM uplmain AS c
INNER JOIN cross_isi_cpl AS cic ON c.pubid = cic.pubid
INNER JOIN cwts ON cic.isi_id = cwts.isi_id
INNER JOIN person_publ AS pp ON c.dbid = pp.dbid
INNER JOIN dept_pers_publ AS dpp ON pp.pd_id = dpp.pd_id
INNER JOIN departments AS d ON dpp.deptid = d.deptid
INNER JOIN dept_inst AS din ON dpp.deptid = din.deptid
WHERE (d.deptid = 371 OR d.parentid = 371 OR d.grandparentid = 371)
AND c.pubyear BETWEEN 2011 AND 2014 --Ändra till aktuella år

UNION

SELECT DISTINCT cwts.isi_id,
	CASE
		WHEN cwts.py = 2011 THEN cwts.jcsx5/cwts.fcsx5 --Ändra till aktuella år
		WHEN cwts.py = 2012 THEN cwts.jcsx4/cwts.fcsx4
		WHEN cwts.py = 2013 THEN cwts.jcsx3/cwts.fcsx3
		WHEN cwts.py = 2014 THEN cwts.jcsx2/cwts.fcsx2
	END AS jxf
FROM uplmain AS c
INNER JOIN cross_isi_gu AS cig ON c.pubid = cig.pubid
INNER JOIN cwts ON cig.isi_id = cwts.isi_id
INNER JOIN person_publ AS pp ON c.dbid = pp.dbid
INNER JOIN dept_pers_publ AS dpp ON pp.pd_id = dpp.pd_id
INNER JOIN departments AS d ON dpp.deptid = d.deptid
INNER JOIN dept_inst AS din ON dpp.deptid = din.deptid
WHERE (d.deptid = 371 OR d.parentid = 371 OR d.grandparentid = 371)
AND c.pubyear BETWEEN 2011 AND 2014 --Ändra till aktuella år
) AS temp